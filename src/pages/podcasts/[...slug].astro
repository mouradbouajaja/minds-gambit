---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const episodes = await getCollection('podcasts');
  return episodes.map(ep => ({
    params: { slug: ep.id },
    props: { ep },
  }));
}

const { ep } = Astro.props;
const { Content } = await render(ep);
---

<BaseLayout title={ep.data.title + " â€” The Mind's Gambit"}>
  <nav id="navbar">
    <div class="nav-inner">
      <a href="/" class="nav-logo">M.<span>B</span></a>
      <ul class="nav-links">
        <li><a href="/">Home</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/podcasts">Podcasts</a></li>
      </ul>
    </div>
  </nav>

  <main class="episode">
    <article>
      <header class="episode-header">
        <a href="/podcasts" class="back-link">&larr; Back to Podcasts</a>
        <time datetime={ep.data.date}>
          {new Date(ep.data.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
        <h1>{ep.data.title}</h1>
        {ep.data.description && <p class="episode-desc">{ep.data.description}</p>}
      </header>

      <!-- Content Lock Overlay -->
      <div class="content-lock-overlay" id="contentLockOverlay">
        <div class="lock-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#c9a84c" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <h2 class="lock-title">Register to Unlock This Episode</h2>
        <p class="lock-subtitle">Create a free account to watch and read the full episode</p>
        <div class="lock-buttons">
          <button class="btn-primary" id="signupBtn">Sign Up</button>
          <button class="btn-secondary" id="signinBtn">Sign In</button>
        </div>
      </div>

      <!-- Locked Content -->
      <div class="locked-content" id="lockedContent">
        <div class="video-container">
          <iframe
            src={`https://www.youtube.com/embed/${ep.data.youtubeId}`}
            title={ep.data.title}
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </div>

        <div class="episode-content">
          <Content />
        </div>

        <footer class="episode-footer">
          <a href="/podcasts" class="back-link">&larr; All Episodes</a>
          {ep.data.youtubeUrl && <a href={ep.data.youtubeUrl} target="_blank" rel="noopener noreferrer" class="yt-link">Watch on YouTube &rarr;</a>}
        </footer>
      </div>
    </article>
  </main>

  <script>
    function initContentGate() {
      const overlay = document.getElementById('contentLockOverlay');
      const content = document.getElementById('lockedContent');
      const signupBtn = document.getElementById('signupBtn');
      const signinBtn = document.getElementById('signinBtn');

      function unlockContent() {
        if (overlay) overlay.style.display = 'none';
        if (content) content.classList.add('unlocked');
      }

      function checkAuth() {
        if (window.Clerk && window.Clerk.user) { unlockContent(); return true; }
        return false;
      }

      if (window.Clerk) {
        window.Clerk.load().then(() => {
          if (!checkAuth()) {
            window.Clerk.addListener(({ user }) => { if (user) unlockContent(); });
          }
        });
      } else {
        const interval = setInterval(() => {
          if (window.Clerk) {
            clearInterval(interval);
            window.Clerk.load().then(() => {
              if (!checkAuth()) {
                window.Clerk.addListener(({ user }) => { if (user) unlockContent(); });
              }
            });
          }
        }, 500);
      }

      if (signupBtn) signupBtn.addEventListener('click', () => { if (window.Clerk) window.Clerk.openSignUp(); });
      if (signinBtn) signinBtn.addEventListener('click', () => { if (window.Clerk) window.Clerk.openSignIn(); });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initContentGate);
    } else {
      initContentGate();
    }
  </script>

  <style>
    .episode { max-width: 800px; margin: 0 auto; padding: 120px 20px 60px; }
    .back-link { color: #c9a84c; text-decoration: none; font-size: 0.9rem; transition: opacity 0.3s; }
    .back-link:hover { opacity: 0.7; }
    .episode-header { margin-bottom: 2rem; }
    .episode-header time { display: block; font-size: 0.8rem; color: #c9a84c; text-transform: uppercase; letter-spacing: 1px; margin: 1rem 0 0.3rem; }
    .episode-header h1 { font-family: 'Playfair Display', Georgia, serif; font-size: 2.5rem; color: #f0e6d2; line-height: 1.2; margin: 0; }
    .episode-desc { color: #aaa; font-size: 1.1rem; margin-top: 0.5rem; line-height: 1.6; }
    .content-lock-overlay { text-align: center; padding: 4rem 2rem; margin: 2rem 0; border: 1px solid rgba(201,168,76,0.2); border-radius: 12px; background: rgba(201,168,76,0.03); }
    .lock-icon { margin-bottom: 1.5rem; }
    .lock-title { font-family: 'Playfair Display', Georgia, serif; color: #f0e6d2; font-size: 1.8rem; margin-bottom: 0.5rem; }
    .lock-subtitle { color: #888; font-size: 1rem; margin-bottom: 2rem; }
    .lock-buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
    .btn-primary { background: #c9a84c; color: #0f1117; border: none; padding: 0.75rem 2rem; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; transition: background 0.2s; }
    .btn-primary:hover { background: #d4b85c; }
    .btn-secondary { background: transparent; color: #c9a84c; border: 1px solid #c9a84c; padding: 0.75rem 2rem; border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
    .btn-secondary:hover { background: rgba(201,168,76,0.1); }
    .locked-content { display: none; }
    .locked-content.unlocked { display: block; }
    .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; border: 1px solid rgba(201,168,76,0.2); margin-bottom: 2rem; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .episode-content { color: #ccc; line-height: 1.8; font-size: 1.05rem; }
    .episode-content :global(h2) { font-family: "Playfair Display", Georgia, serif; color: #c9a84c; font-size: 1.5rem; margin-top: 2rem; }
    .episode-content :global(p) { margin-bottom: 1rem; }
    .episode-content :global(a) { color: #c9a84c; text-decoration: underline; }
    .episode-footer { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid rgba(201,168,76,0.15); display: flex; justify-content: space-between; align-items: center; }
    .yt-link { color: #c9a84c; text-decoration: none; font-size: 0.9rem; }
    .yt-link:hover { text-decoration: underline; }
    @media (max-width: 600px) { .episode-header h1 { font-size: 1.8rem; } }
  </style>
</BaseLayout>
